#!/bin/bash
# AIM - AI-Collaboration-Management Launcher
# Usage: aim [project_path] [command]

set -e

AIM_IMAGE="aim"
STATE_VOLUME="aim-state"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

AIM_DIR="$(cd "$(dirname "$0")" && pwd)"

show_help() {
    echo "AIM - AI-Collaboration-Management"
    echo ""
    echo "Usage:"
    echo "  aim init [project_path]      Initialize AIM workflow in a project"
    echo "  aim [project_path]           Start AIM Docker shell for project"
    echo "  aim [project_path] claude    Start Claude Code inside AIM container"
    echo "  aim [project_path] validate  Validate branches"
    echo "  aim [project_path] watch     Watch for new branches"
    echo "  aim build                    Build/rebuild AIM image"
    echo "  aim status                   Show AIM status"
    echo "  aim help                     Show this help"
    echo ""
    echo "Examples:"
    echo "  aim init ~/my-project        Copy AIM workflow to project"
    echo "  aim /path/to/my-project      Start AIM on project"
    echo "  aim ~/my-project claude      Start Claude in AIM container"
    echo "  aim .                        Start AIM on current directory"
    echo "  aim                          Start AIM on current directory"
}

build_image() {
    echo -e "${BLUE}Building AIM Docker image...${NC}"
    docker build -t "$AIM_IMAGE" "$AIM_DIR"
    echo -e "${GREEN}AIM image built successfully${NC}"
}

init_project() {
    local project_path="$1"

    # Resolve to absolute path
    if [[ "$project_path" == "." ]]; then
        project_path="$(pwd)"
    elif [[ ! "$project_path" = /* ]]; then
        project_path="$(cd "$project_path" 2>/dev/null && pwd)"
    fi

    # Verify path exists
    if [[ ! -d "$project_path" ]]; then
        echo -e "${RED}Error: Project path not found: $project_path${NC}"
        exit 1
    fi

    local project_name=$(basename "$project_path")

    echo -e "${BLUE}Initializing AIM workflow in: ${project_name}${NC}"
    echo ""

    # Create .claude directory
    if [[ ! -d "$project_path/.claude" ]]; then
        mkdir -p "$project_path/.claude/commands"
        echo -e "${GREEN}✓ Created .claude/ directory${NC}"
    else
        echo -e "${BLUE}• .claude/ already exists${NC}"
    fi

    # Copy settings.json with hooks
    if [[ ! -f "$project_path/.claude/settings.json" ]]; then
        cat > "$project_path/.claude/settings.json" << 'EOF'
{
  "$schema": "https://json.schemastore.org/claude-code-settings.json",
  "permissions": {
    "allow": [
      "Read", "Edit", "Write", "Glob", "Grep", "SlashCommand", "TodoWrite", "WebFetch", "WebSearch", "Task", "NotebookEdit", "BashOutput", "KillShell", "AskUserQuestion", "Skill", "ExitPlanMode", "Bash(git:*)", "Bash(wc:*)", "Bash(ls:*)", "Bash(rm:*)", "Bash(chmod:*)", "Bash(test:*)", "Bash(bash:*)", "Bash(./scripts/*)", "Bash(mkdir:*)", "Bash(cat:*)", "Bash(echo:*)", "Bash(ps:*)", "Bash(kill:*)", "Bash(pkill:*)", "Bash(sleep:*)", "Bash(find:*)", "Bash(grep:*)", "Bash(head:*)", "Bash(tail:*)", "Bash(sort:*)", "Bash(uniq:*)", "Bash(awk:*)", "Bash(sed:*)", "Bash(curl:*)", "Bash(wget:*)", "Bash(npm:*)", "Bash(yarn:*)", "Bash(pip:*)", "Bash(python:*)", "Bash(node:*)", "Bash(make:*)", "Bash(docker:*)", "Bash(xcode:*)", "Bash(open:*)", "Bash(pbcopy:*)", "Bash(pbpaste:*)", "Bash(defaults:*)", "Bash(osascript:*)", "Bash(afplay:*)", "Bash(./update-aicm.sh)", "Bash(./install.sh:*)", "Bash(source ~/.zshrc)", "Bash(./scripts/tcc-file-compliance.sh:*)", "Bash(./scripts/tcc-validate-branch.sh:*)", "Bash(./scripts/cleanup-watchers.sh:*)", "Bash(./scripts/aim-launcher.sh:*)", "Bash(xxd:*)", "Bash(aim-init:*)", "Bash(strace:*)", "Bash(timeout:*)", "SlashCommand(/works-ready)", "SlashCommand(/check-the-board)", "SlashCommand(/merge-to-main)", "SlashCommand(/verify)", "SlashCommand(/fix-violations)", "Read(//private/tmp/**)", "Bash(./scripts/:*)", "Bash(gh:*)", "Bash(./update-aicm.sh)", "Bash(./install.sh:*)", "Bash(source ~/.zshrc)", "Bash(./scripts/tcc-file-compliance.sh:*)", "Bash(./scripts/tcc-validate-branch.sh:*)", "Bash(bash:*)", "Bash(pkill:*)", "Bash(./scripts/cleanup-watchers.sh:*)", "Bash(./scripts/aim-launcher.sh:*)", "Bash(xxd:*)", "Bash(aim-init:*)", "Bash(chmod:*)", "Bash(git fetch:*)", "Bash(git checkout:*)", "Bash(test:*)", "Bash(git merge:*)", "Bash(git rev-parse:*)", "Bash(git push:*)", "Bash(git branch:*)", "Bash(git pull:*)", "Bash(git add:*)", "Bash(git commit:*)", "Bash(/tmp/branch-watcher-*.pid)", "Bash(/tmp/board-watcher-*.pid)", "Bash(git tag:*)", "Bash(recent-commits.txt)", "Bash(cat:*)", "Bash(git show:*)", "Bash(scripts/watch-branches.sh:*)", "Bash(scripts/watch-board.sh:*)", "Bash(/tmp/branch-watcher-*.state)", "Bash(kill:*)", "Bash(strace:*)", "Bash(timeout 3s cat:*)", "Bash(./scripts/watch-all.sh:*)", "Bash(./aim help:*)", "Bash(mv:*)"
    ]
  },
  "hooks": {
    "SessionStart": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": ".claude/hooks/session-start.sh",
            "timeout": 10
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": "^(wr|works ready)$",
        "hooks": [
          {
            "type": "command",
            "command": ".claude/hooks/works-ready-hook.sh",
            "timeout": 15
          }
        ]
      }
    ]
  }
}
EOF
        echo -e "${GREEN}✓ Created .claude/settings.json${NC}"
    else
        echo -e "${BLUE}• .claude/settings.json already exists${NC}"
    fi

    # Create hooks directory and hook files
    if [[ ! -d "$project_path/.claude/hooks" ]]; then
        mkdir -p "$project_path/.claude/hooks"
        echo -e "${GREEN}✓ Created .claude/hooks/ directory${NC}"
    else
        echo -e "${BLUE}• .claude/hooks/ already exists${NC}"
    fi

    # Create session-start.sh hook
    if [[ ! -f "$project_path/.claude/hooks/session-start.sh" ]]; then
        cat > "$project_path/.claude/hooks/session-start.sh" << 'EOF'
#!/bin/bash
# SessionStart hook - Displays startup context and launches monitoring

REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
REPO_NAME=$(basename "$REPO_ROOT" 2>/dev/null || echo "UNKNOWN")

cd "$REPO_ROOT" || exit 1

# Execute the session-start display script
"$REPO_ROOT/.claude/hooks/session-start-display.sh"
EOF
        chmod +x "$project_path/.claude/hooks/session-start.sh"
        echo -e "${GREEN}✓ Created .claude/hooks/session-start.sh${NC}"
    else
        echo -e "${BLUE}• .claude/hooks/session-start.sh already exists${NC}"
    fi

    # Create session-start-display.sh hook
    if [[ ! -f "$project_path/.claude/hooks/session-start-display.sh" ]]; then
        cat > "$project_path/.claude/hooks/session-start-display.sh" << 'EOF'
#!/bin/bash
# Session Start Display - Simple status check for deployed AIM repos

REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
REPO_NAME=$(basename "$REPO_ROOT" 2>/dev/null || echo "UNKNOWN")

cd "$REPO_ROOT" || exit 1

# Quick sync check
git fetch origin --quiet 2>/dev/null || true

# Check for OCC branches
OCC_BRANCHES=$(git branch -r | grep 'origin/claude/' 2>/dev/null | wc -l | xargs)

# Simple status output
if [ "$OCC_BRANCHES" -gt 0 ]; then
    echo "SessionStart:startup hook success: FOUND_BRANCHES"
    echo "Status: $OCC_BRANCHES OCC branch(es) found"
    echo "Action: Use 'wr' or '/works-ready' to process"
else
    echo "SessionStart:startup hook success: NO_BRANCHES"
    echo "Status: No pending OCC branches"
    echo "Action: Standing by"
fi

# Start watcher if available and not running
if [ -f "$REPO_ROOT/scripts/watch-all.sh" ]; then
    PID_FILE="/tmp/aim-watcher-${REPO_NAME}.pid"
    if [ ! -f "$PID_FILE" ] || ! ps -p "$(cat "$PID_FILE" 2>/dev/null)" >/dev/null 2>&1; then
        nohup "$REPO_ROOT/scripts/watch-all.sh" >/tmp/aim-watcher-${REPO_NAME}.log 2>&1 &
        echo $! > "$PID_FILE"
        echo "Watcher: Started in background" >&2
    else
        echo "Watcher: Already running" >&2
    fi
fi
EOF
        chmod +x "$project_path/.claude/hooks/session-start-display.sh"
        echo -e "${GREEN}✓ Created .claude/hooks/session-start-display.sh${NC}"
    else
        echo -e "${BLUE}• .claude/hooks/session-start-display.sh already exists${NC}"
    fi

    # Create works-ready-hook.sh
    if [[ ! -f "$project_path/.claude/hooks/works-ready-hook.sh" ]]; then
        cat > "$project_path/.claude/hooks/works-ready-hook.sh" << 'EOF'
#!/bin/bash
# Works Ready Hook - AUTO-EXECUTES validation and merge

REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
REPO_NAME=$(basename "$REPO_ROOT")
PENDING_FILE="/tmp/branch-watcher-${REPO_NAME}.pending"

cd "$REPO_ROOT" 2>/dev/null || exit 0

# Find OCC branch to validate
BRANCH=""
if [ -f "$PENDING_FILE" ] && [ -s "$PENDING_FILE" ]; then
    BRANCH=$(head -1 "$PENDING_FILE" | awk '{print $1}')
fi

if [ -z "$BRANCH" ]; then
    # Check for remote OCC branches
    git fetch origin --quiet 2>/dev/null
    CURRENT=$(git branch --show-current)
    BRANCH=$(git branch -r | grep 'origin/claude/' | grep -v "origin/$CURRENT" | head -1 | sed 's/.*origin\///' | xargs)
fi

echo ""
echo "═══════════════════════════════════════════════════════════════════════════════"
echo "WORKS READY - AUTO-EXECUTE MODE"
echo "═══════════════════════════════════════════════════════════════════════════════"
echo ""

if [ -z "$BRANCH" ]; then
    echo "STATUS: No OCC branches found to merge."
    echo ""
    echo "INSTRUCTION: Report to user that there are no pending branches to validate."
    echo "Do NOT ask questions. Just report the status."
    echo "═══════════════════════════════════════════════════════════════════════════════"
    exit 0
fi

echo "INSTRUCTION: Execute /works-ready IMMEDIATELY for branch: $BRANCH"
echo "Do NOT ask questions. Just execute the slash command."
echo "═══════════════════════════════════════════════════════════════════════════════"
EOF
        chmod +x "$project_path/.claude/hooks/works-ready-hook.sh"
        echo -e "${GREEN}✓ Created .claude/hooks/works-ready-hook.sh${NC}"
    else
        echo -e "${BLUE}• .claude/hooks/works-ready-hook.sh already exists${NC}"
    fi

    # Create works-ready command
    if [[ ! -f "$project_path/.claude/commands/works-ready.md" ]]; then
        cat > "$project_path/.claude/commands/works-ready.md" << 'EOF'
---
description: TCC validates and merges OCC branch to main
---

**EXECUTE IMMEDIATELY. DO NOT ASK FOR CONFIRMATION.**

You are TCC. Complete these steps:

## Step 1: Check for pending branches

```bash
git fetch origin
git branch -r | grep "origin/claude/"
```

If no branches found, report "No pending branches" and stop.

## Step 2: Validate the branch

```bash
git checkout <branch-name>
```

- Check for obvious errors
- Verify files are reasonable size
- Run tests if available

## Step 3: Merge to main

```bash
git checkout main
git merge <branch-name>
git push origin main
```

## Step 4: Cleanup

```bash
git push origin --delete <branch-name>
git branch -D <branch-name>
```

## Step 5: Update board

Add completion record to docs/BOARD.md with commit hash.

## Report

```
✅ MERGE COMPLETE
- Branch: [name] (deleted)
- Commit: [hash]
- Board: Updated
```
EOF
        echo -e "${GREEN}✓ Created .claude/commands/works-ready.md${NC}"
    else
        echo -e "${BLUE}• .claude/commands/works-ready.md already exists${NC}"
    fi

    # Create scripts directory and copy essential scripts
    if [[ ! -d "$project_path/scripts" ]]; then
        mkdir -p "$project_path/scripts"
        echo -e "${GREEN}✓ Created scripts/ directory${NC}"
    else
        echo -e "${BLUE}• scripts/ already exists${NC}"
    fi

    # Copy essential AIM scripts
    local scripts_to_copy=(
        "watch-all.sh"
        "tcc-validate-branch.sh"
        "tcc-file-compliance.sh"
        "cleanup-watchers.sh"
    )

    for script in "${scripts_to_copy[@]}"; do
        if [[ -f "$AIM_DIR/scripts/$script" ]]; then
            if [[ ! -f "$project_path/scripts/$script" ]]; then
                cp "$AIM_DIR/scripts/$script" "$project_path/scripts/"
                chmod +x "$project_path/scripts/$script"
                echo -e "${GREEN}✓ Copied scripts/$script${NC}"
            else
                echo -e "${BLUE}• scripts/$script already exists${NC}"
            fi
        fi
    done

    # Create docs directory and BOARD.md
    if [[ ! -d "$project_path/docs" ]]; then
        mkdir -p "$project_path/docs"
        echo -e "${GREEN}✓ Created docs/ directory${NC}"
    fi

    if [[ ! -f "$project_path/docs/BOARD.md" ]]; then
        cat > "$project_path/docs/BOARD.md" << EOF
# AIM Task Board - ${project_name}

## Tasks FOR OCC (TCC writes here, OCC reads)

*No pending OCC tasks*

## Tasks FOR TCC (OCC writes here, TCC reads)

*No pending TCC tasks*

---

**Board Status:** Initialized
**Project:** ${project_name}
**Created:** $(date +%Y-%m-%d)
EOF
        echo -e "${GREEN}✓ Created docs/BOARD.md${NC}"
    else
        echo -e "${BLUE}• docs/BOARD.md already exists${NC}"
    fi

    # Create CLAUDE.md
    if [[ ! -f "$project_path/CLAUDE.md" ]]; then
        cat > "$project_path/CLAUDE.md" << 'EOF'
# CLAUDE.md - AIM Workflow Instructions

**This file defines the TCC/OCC workflow for AI collaboration.**

---

## Roles

- **OCC** (Online Claude Code) = Developer
  - Writes code on feature branches (claude/*)
  - Commits and pushes to remote
  - Updates BOARD.md when work is ready for review

- **TCC** (Testing/Coordination Claude) = Project Manager
  - Validates OCC branches before merge
  - Runs tests and checks compliance
  - Merges validated work to main
  - Updates BOARD.md after completing tasks

---

## Workflow

1. **OCC** creates feature branch: `claude/feature-name-<session-id>`
2. **OCC** commits work and pushes to remote
3. **OCC** writes task to BOARD.md under "Tasks FOR TCC"
4. **TCC** validates the branch (tests, compliance)
5. **TCC** merges to main if valid, or posts issues to BOARD.md
6. **TCC** deletes merged branch and updates BOARD.md

---

## Board Location

Task board: `docs/BOARD.md`

---

## Session Start

When starting a session, check `docs/BOARD.md` for:
- Tasks assigned to your role
- Pending branches to process
- Status of recent work

---

## Pattern Propagation Rule

When fixing ANY pattern (paths, APIs, configs):
1. `grep -rn "<pattern>" .` to find ALL instances
2. Fix ALL occurrences, not just the one encountered
3. If pattern came from AIM init, fix the SOURCE TEMPLATE

### Common Patterns to Check:
- Hardcoded paths: `/home/user`, `/Users/`, `/Volumes/`
- Project names: `SimpleCP`, `AI-Collaboration-Management`
- Absolute paths that should be relative

### Standard Path Detection (use in ALL shell scripts):
```bash
# Use relative paths - detect repo root from script location
REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
```
EOF
        echo -e "${GREEN}✓ Created CLAUDE.md${NC}"
    else
        echo -e "${BLUE}• CLAUDE.md already exists${NC}"
    fi

    # Add .claude/settings.json to .gitignore
    if [[ ! -f "$project_path/.gitignore" ]] || ! grep -q "\.claude/settings\.json" "$project_path/.gitignore"; then
        if [[ ! -f "$project_path/.gitignore" ]]; then
            touch "$project_path/.gitignore"
        fi
        echo -e "\n# Claude Code local settings (machine-specific)\n.claude/settings.json" >> "$project_path/.gitignore"
        echo -e "${GREEN}✓ Added .claude/settings.json to .gitignore${NC}"
    else
        echo -e "${BLUE}• .claude/settings.json already in .gitignore${NC}"
    fi

    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}AIM workflow initialized in: ${project_name}${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "Files created:"
    echo "  • CLAUDE.md                           - AI role definitions"
    echo "  • .claude/settings.json               - Claude Code settings + hooks (gitignored)"
    echo "  • .claude/hooks/session-start.sh      - Session initialization hook"
    echo "  • .claude/hooks/session-start-display.sh - Startup status display"
    echo "  • .claude/hooks/works-ready-hook.sh   - Auto-execution hook"
    echo "  • .claude/commands/works-ready.md     - TCC merge command"
    echo "  • scripts/watch-all.sh                - Branch and board watcher"
    echo "  • scripts/tcc-validate-branch.sh      - Branch validation"
    echo "  • scripts/tcc-file-compliance.sh      - File size compliance"
    echo "  • scripts/cleanup-watchers.sh         - Cleanup utilities"
    echo "  • docs/BOARD.md                       - Task tracking board"
    echo ""
    echo "Next steps:"
    echo "  1. cd $project_path"
    echo "  2. git add CLAUDE.md .claude/commands .claude/hooks scripts docs/BOARD.md .gitignore"
    echo "  3. git commit -m 'Add AIM workflow'"
    echo "  4. Start Claude Code session"
    echo ""
    echo "Or use Docker isolation:"
    echo "  aim $project_path"
    echo ""
}

show_status() {
    echo -e "${BLUE}AIM - AI-Collaboration-Management${NC}"
    echo ""
    echo "AIM Directory: $AIM_DIR"
    echo ""

    # Check Docker image
    if docker image inspect "$AIM_IMAGE" >/dev/null 2>&1; then
        echo -e "${GREEN}✓ Docker image 'aim' is built${NC}"
    else
        echo -e "${RED}✗ Docker image not built. Run: aim build${NC}"
    fi

    # Check Docker running
    if docker info >/dev/null 2>&1; then
        echo -e "${GREEN}✓ Docker is running${NC}"
    else
        echo -e "${RED}✗ Docker is not running${NC}"
    fi

    echo ""
}

run_aim() {
    local project_path="$1"
    local command="${2:-shell}"

    # Resolve to absolute path
    if [[ "$project_path" == "." ]]; then
        project_path="$(pwd)"
    elif [[ ! "$project_path" = /* ]]; then
        project_path="$(cd "$project_path" 2>/dev/null && pwd)"
    fi

    # Verify path exists
    if [[ ! -d "$project_path" ]]; then
        echo -e "${RED}Error: Project path not found: $project_path${NC}"
        exit 1
    fi

    # Check if image exists
    if ! docker image inspect "$AIM_IMAGE" >/dev/null 2>&1; then
        echo -e "${BLUE}AIM image not found. Building...${NC}"
        build_image
    fi

    # Handle claude command specifically
    if [[ "$command" == "claude" ]]; then
        echo -e "${BLUE}Starting Claude Code CLI in AIM container for: $(basename "$project_path")${NC}"
        docker run -it --rm \
            -v "$project_path":/project \
            -v "$STATE_VOLUME":/aim/state \
            "$AIM_IMAGE" bash -c "cd /project && claude"
    else
        # Run container with specified command
        docker run -it --rm \
            -v "$project_path":/project \
            -v "$STATE_VOLUME":/aim/state \
            "$AIM_IMAGE" "$command"
    fi
}

# Main
case "${1:-}" in
    help|--help|-h)
        show_help
        ;;
    build)
        build_image
        ;;
    init)
        if [[ -z "$2" ]]; then
            init_project "$(pwd)"
        else
            init_project "$2"
        fi
        ;;
    status)
        show_status
        ;;
    "")
        run_aim "$(pwd)" "shell"
        ;;
    *)
        if [[ -d "$1" ]] || [[ "$1" == "." ]]; then
            run_aim "$1" "${2:-shell}"
        else
            # Assume it's a command for current directory
            run_aim "$(pwd)" "$1"
        fi
        ;;
esac
